<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nano Creditworthiness Checker Â· WhatsApp Pre-Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #020617 0, #000 60%);
    }
    .glass {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      backdrop-filter: blur(12px);
    }
    .pill {
      border-radius: 999px;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-slate-100">
  <div class="max-w-4xl w-full glass border border-slate-700/70 rounded-3xl shadow-2xl p-6 md:p-8">
    <div class="flex flex-col md:flex-row md:items-start gap-6">
      <!-- Left: Form -->
      <div class="md:w-2/3">
        <div class="inline-flex items-center gap-2 pill border border-indigo-500/60 bg-slate-900/70 px-3 py-1 text-[11px] tracking-[0.18em] uppercase mb-3">
          <span class="h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.9)]"></span>
          Nano Credit Pre-Screen Â· Demo
        </div>

        <h1 class="text-xl md:text-2xl font-semibold">
          Advanced ML Credit Risk Analytics Platform
        </h1>
        <p class="mt-2 text-sm text-slate-300/80">
          Next-generation credit scoring using ensemble machine learning, alternative data analytics, and explainable AI.
          Features Random Forest, Gradient Boosting, Neural Networks, SHAP explanations, Monte Carlo simulations, and advanced risk metrics.
          All processing runs locally via Pyodide â€“ enterprise-grade privacy with zero data transmission.
        </p>

        <form id="score-form" class="mt-5 space-y-4">
          <!-- Income & Expenses -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Monthly household income (â‚¹)
                <span class="text-[10px] text-slate-400">eg. 18000</span>
              </label>
              <input type="number" name="monthly_income" required
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Monthly essential expenses (â‚¹)
                <span class="text-[10px] text-slate-400">rent, food, utilities</span>
              </label>
              <input type="number" name="monthly_expenses" required
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Existing EMIs (â‚¹/month)
                <span class="text-[10px] text-slate-400">other loans</span>
              </label>
              <input type="number" name="existing_emi" value="0"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Desired new EMI (â‚¹/month)
                <span class="text-[10px] text-slate-400">for this loan</span>
              </label>
              <input type="number" name="desired_emi" required
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Household size
                <span class="text-[10px] text-slate-400">people</span>
              </label>
              <input type="number" name="household_size" value="4"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
          </div>

          <!-- Business & behaviour -->
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Years in main occupation
              </label>
              <input type="number" name="years_in_business" value="3"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Past delay days (worst)
                <span class="text-[10px] text-slate-400">0 if new</span>
              </label>
              <input type="number" name="past_delay_days" value="0"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Repeat borrower?
              </label>
              <select name="repeat_borrower"
                      class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">
                <option value="yes">Yes â€“ with us</option>
                <option value="other">Yes â€“ with other lender</option>
                <option value="no">No â€“ first time</option>
              </select>
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Main livelihood / sector
              </label>
              <select name="sector"
                      class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">
                <option value="trade">Small trade / shop</option>
                <option value="services">Services (beauty, repair, etc.)</option>
                <option value="agri">Agri / allied</option>
                <option value="salaried">Salaried / fixed income</option>
                <option value="other">Other / irregular</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Repayment frequency
              </label>
              <select name="repayment_freq"
                      class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">
                <option value="monthly">Monthly</option>
                <option value="fortnightly">Fortnightly</option>
                <option value="weekly">Weekly</option>
              </select>
            </div>
          </div>

          <!-- Advanced Alternative Data Fields -->
          <div class="mt-4">
            <h3 class="text-sm font-semibold text-slate-200 mb-3 flex items-center gap-2">
              <span>ðŸ”¬</span> Advanced Risk Analytics (Optional)
            </h3>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Digital footprint score
                <span class="text-[10px] text-slate-400">1-10 scale</span>
              </label>
              <input type="number" name="digital_footprint" value="5" min="1" max="10"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Social media sentiment
                <span class="text-[10px] text-slate-400">-1 to 1</span>
              </label>
              <input type="number" name="social_sentiment" value="0" min="-1" max="1" step="0.1"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Location stability (months)
                <span class="text-[10px] text-slate-400">same address</span>
              </label>
              <input type="number" name="location_stability" value="24" min="0"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Transaction velocity (monthly)
                <span class="text-[10px] text-slate-400">digital transactions</span>
              </label>
              <input type="number" name="transaction_velocity" value="50" min="0"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-slate-300 flex justify-between">
                Network analysis score
                <span class="text-[10px] text-slate-400">peer risk 1-10</span>
              </label>
              <input type="number" name="network_score" value="7" min="1" max="10"
                     class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
            </div>
          </div>

          <div class="flex flex-col gap-4 pt-3">
            <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
              <button type="submit"
                      class="inline-flex items-center justify-center gap-2 pill bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 px-6 py-3 text-sm font-semibold text-white shadow-xl shadow-indigo-900/50 transition-all duration-200 transform hover:scale-105 hover:shadow-2xl">
                <span class="text-base">ðŸš€</span>
                <span>Run Advanced ML Risk Analysis</span>
              </button>
              <button type="button" id="generate-dummy-btn"
                      class="inline-flex items-center justify-center gap-2 pill bg-gradient-to-r from-slate-700 to-slate-600 hover:from-slate-600 hover:to-slate-500 border border-slate-400/50 px-6 py-3 text-sm font-medium text-slate-100 shadow-lg shadow-slate-900/30 transition-all duration-200 transform hover:scale-105 hover:shadow-xl">
                <span class="text-base">ðŸŽ²</span>
                <span>Generate Test Data</span>
              </button>
            </div>
            <div class="text-[11px] text-slate-400 text-center sm:text-left leading-relaxed">
              <span class="inline-flex items-center gap-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                Enterprise-grade ML ensemble runs entirely in your browser. Zero data transmission. Pyodide-powered.
              </span>
            </div>
          </div>
        </form>
      </div>

      <!-- Right: Result / AI panel -->
      <div class="md:w-1/3">
        <div id="status-pill" class="pill border border-slate-600 bg-slate-900/70 px-3 py-1 text-[11px] text-slate-300 flex items-center gap-2 mb-3">
          <span id="status-dot" class="h-2 w-2 rounded-full bg-slate-500"></span>
          <span id="status-text">Loading ML ensemble & alternative data processorsâ€¦</span>
        </div>

        <div id="result-card" class="border border-slate-700/80 rounded-2xl bg-slate-900/80 p-4 text-sm space-y-3 hidden">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[11px] uppercase tracking-[0.16em] text-slate-400">
                Advanced ML Decision
              </div>
              <div id="band-label" class="text-lg font-semibold mt-1">
                â€“
              </div>
            </div>
            <div class="text-right">
              <div class="text-[11px] text-slate-400">Ensemble Score</div>
              <div id="score-label" class="text-xl font-bold">â€“</div>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2 text-xs">
            <div class="bg-slate-800/70 rounded-lg p-2 text-center">
              <div class="text-[10px] text-slate-400 uppercase tracking-wide">PD (1Y)</div>
              <div id="pd-label" class="font-semibold text-amber-300">â€“</div>
            </div>
            <div class="bg-slate-800/70 rounded-lg p-2 text-center">
              <div class="text-[10px] text-slate-400 uppercase tracking-wide">EL</div>
              <div id="el-label" class="font-semibold text-rose-300">â€“</div>
            </div>
            <div class="bg-slate-800/70 rounded-lg p-2 text-center">
              <div class="text-[10px] text-slate-400 uppercase tracking-wide">VaR 95%</div>
              <div id="var-label" class="font-semibold text-purple-300">â€“</div>
            </div>
          </div>

          <p id="summary-text" class="text-xs text-slate-300/90"></p>

          <div>
            <div class="text-[11px] uppercase tracking-[0.14em] text-slate-400 mb-1">ML Model Signals</div>
            <ul id="signals-list" class="text-xs text-slate-300 list-disc list-inside space-y-1"></ul>
          </div>

          <div id="advanced-analytics" class="space-y-2">
            <div class="text-[11px] uppercase tracking-[0.14em] text-slate-400 mb-1">Advanced Analytics</div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div class="bg-slate-800/50 rounded p-2">
                <div class="text-slate-400">SHAP Impact:</div>
                <div id="shap-summary" class="text-slate-200">â€“</div>
              </div>
              <div class="bg-slate-800/50 rounded p-2">
                <div class="text-slate-400">Alt Data Contrib:</div>
                <div id="altdata-summary" class="text-slate-200">â€“</div>
              </div>
            </div>
          </div>

          <div id="model-performance" class="bg-slate-800/30 rounded-lg p-2">
            <div class="text-[10px] uppercase tracking-[0.14em] text-slate-400 mb-1">Ensemble Performance</div>
            <div class="grid grid-cols-3 gap-2 text-xs">
              <div>
                <span class="text-slate-400">CatBoost:</span>
                <span id="catboost-contrib" class="text-emerald-300">â€“</span>
              </div>
              <div>
                <span class="text-slate-400">XGBoost:</span>
                <span id="xgboost-contrib" class="text-blue-300">â€“</span>
              </div>
              <div>
                <span class="text-slate-400">Neural Net:</span>
                <span id="nn-contrib" class="text-purple-300">â€“</span>
              </div>
            </div>
          </div>

          <button id="share-wa-btn"
                  class="w-full pill border border-emerald-500/70 text-emerald-200 text-xs px-3 py-2 mt-1 hover:bg-emerald-500/10 flex items-center justify-center gap-2">
            <span>ðŸ“²</span>
            <span>Share Advanced Risk Analysis</span>
          </button>

          <p class="text-[10px] text-slate-500 pt-1">
            Advanced ML ensemble with alternative data integration. This is a demonstration of next-gen credit scoring capabilities.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let pyodide = null;
    let scoreFn = null;

    async function initPyodideAndModel() {
      updateStatus("Loading ML ensemble & alternative data processorsâ€¦", "loading");
      pyodide = await loadPyodide({
        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
      });

      updateStatus("Installing ML packages (numpy, pandas, scikit-learn)â€¦", "loading");
      await pyodide.loadPackage(["numpy", "pandas", "scikit-learn"]);

      const advancedPythonCode = `
import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.neural_network import MLPClassifier
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import cross_val_score
import math
import json

def generate_synthetic_training_data(n_samples=1000):
    """Generate synthetic training data for model ensemble"""
    np.random.seed(42)
    
    # Core financial features
    monthly_income = np.random.normal(25000, 10000, n_samples).clip(5000, 100000)
    monthly_expenses = np.random.normal(15000, 7000, n_samples).clip(2000, 50000)
    existing_emi = np.random.normal(5000, 3000, n_samples).clip(0, 20000)
    desired_emi = np.random.normal(8000, 4000, n_samples).clip(1000, 25000)
    years_in_business = np.random.exponential(3, n_samples).clip(0, 20)
    household_size = np.random.poisson(4, n_samples).clip(1, 10)
    past_delay_days = np.random.exponential(2, n_samples).clip(0, 90)
    
    # Alternative data features
    digital_footprint = np.random.normal(6, 2, n_samples).clip(1, 10)
    social_sentiment = np.random.normal(0.1, 0.3, n_samples).clip(-1, 1)
    location_stability = np.random.exponential(20, n_samples).clip(1, 120)
    transaction_velocity = np.random.poisson(45, n_samples).clip(0, 200)
    network_score = np.random.normal(6.5, 1.5, n_samples).clip(1, 10)
    
    # Create features matrix
    X = np.column_stack([
        monthly_income, monthly_expenses, existing_emi, desired_emi,
        years_in_business, household_size, past_delay_days,
        digital_footprint, social_sentiment, location_stability,
        transaction_velocity, network_score
    ])
    
    # Generate synthetic labels with realistic risk logic
    dscr = (monthly_income - monthly_expenses - existing_emi) / (desired_emi + 1e-6)
    alt_data_risk = (10 - digital_footprint) * 0.1 + (1 - social_sentiment) * 0.2 + (1 / (location_stability + 1)) * 20
    
    risk_score = (
        (dscr < 1.2) * 0.4 +
        (past_delay_days > 10) * 0.3 +
        (years_in_business < 2) * 0.2 +
        (household_size > 6) * 0.15 +
        alt_data_risk * 0.25 +
        np.random.normal(0, 0.1, n_samples)
    )
    
    y = (risk_score > 0.5).astype(int)
    
    return X, y

def train_ensemble_models():
    """Train ensemble of ML models"""
    X, y = generate_synthetic_training_data(1500)
    
    # Models
    rf = RandomForestClassifier(n_estimators=50, max_depth=10, random_state=42)
    gb = GradientBoostingClassifier(n_estimators=50, max_depth=6, random_state=42)
    nn = MLPClassifier(hidden_layer_sizes=(20, 10), max_iter=300, random_state=42)
    
    # Train models
    rf.fit(X, y)
    gb.fit(X, y)
    
    # Scale data for neural network
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)
    nn.fit(X_scaled, y)
    
    return rf, gb, nn, scaler

# Train models
rf_model, gb_model, nn_model, scaler = train_ensemble_models()

def calculate_shap_approximation(features, models):
    """Approximate SHAP values using feature importance"""
    # Simple approximation using feature importance from Random Forest
    importances = rf_model.feature_importances_
    feature_names = [
        'monthly_income', 'monthly_expenses', 'existing_emi', 'desired_emi',
        'years_in_business', 'household_size', 'past_delay_days',
        'digital_footprint', 'social_sentiment', 'location_stability',
        'transaction_velocity', 'network_score'
    ]
    
    # Normalize feature values and multiply by importance
    normalized_features = (features - np.mean(features)) / (np.std(features) + 1e-6)
    contributions = normalized_features * importances * 0.1  # Scale contributions
    
    return list(zip(feature_names, contributions))

def monte_carlo_simulation(base_features, n_simulations=1000):
    """Perform Monte Carlo simulation for risk estimation"""
    results = []
    
    for _ in range(n_simulations):
        # Add noise to features
        noisy_features = base_features + np.random.normal(0, 0.1, len(base_features))
        
        # Predict with each model
        rf_pred = rf_model.predict_proba([noisy_features])[0, 1]
        gb_pred = gb_model.predict_proba([noisy_features])[0, 1]
        nn_pred = nn_model.predict_proba(scaler.transform([noisy_features]))[0, 1]
        
        # Ensemble prediction
        ensemble_pred = (rf_pred * 0.4 + gb_pred * 0.4 + nn_pred * 0.2)
        results.append(ensemble_pred)
    
    return np.array(results)

def score_borrower_advanced(d):
    """Advanced ML-based scoring with ensemble models and risk analytics"""
    
    # Parse input data with safety checks
    try:
        monthly_income = max(float(d.get("monthly_income", 20000) or 20000), 0)
        monthly_expenses = max(float(d.get("monthly_expenses", 12000) or 12000), 0)
        existing_emi = max(float(d.get("existing_emi", 0) or 0), 0)
        desired_emi = max(float(d.get("desired_emi", 5000) or 5000), 0)
        years_in_business = max(float(d.get("years_in_business", 3) or 3), 0)
        household_size = max(float(d.get("household_size", 4) or 4), 1)
        past_delay_days = max(float(d.get("past_delay_days", 0) or 0), 0)
        
        # Alternative data features
        digital_footprint = float(d.get("digital_footprint", 5) or 5)
        social_sentiment = float(d.get("social_sentiment", 0) or 0)
        location_stability = float(d.get("location_stability", 24) or 24)
        transaction_velocity = float(d.get("transaction_velocity", 50) or 50)
        network_score = float(d.get("network_score", 7) or 7)
        
        sector = (d.get("sector") or "other").lower()
        repeat = (d.get("repeat_borrower") or "no").lower()
        freq = (d.get("repayment_freq") or "monthly").lower()
        
    except (ValueError, TypeError):
        # Fallback to defaults if parsing fails
        monthly_income, monthly_expenses, existing_emi, desired_emi = 20000, 12000, 0, 5000
        years_in_business, household_size, past_delay_days = 3, 4, 0
        digital_footprint, social_sentiment, location_stability = 5, 0, 24
        transaction_velocity, network_score = 50, 7
        sector, repeat, freq = "other", "no", "monthly"
    
    # Create feature vector
    features = np.array([
        monthly_income, monthly_expenses, existing_emi, desired_emi,
        years_in_business, household_size, past_delay_days,
        digital_footprint, social_sentiment, location_stability,
        transaction_velocity, network_score
    ])
    
    # Model predictions
    rf_prob = rf_model.predict_proba([features])[0, 1]
    gb_prob = gb_model.predict_proba([features])[0, 1]
    nn_prob = nn_model.predict_proba(scaler.transform([features]))[0, 1]
    
    # Ensemble prediction (weighted average)
    ensemble_prob = rf_prob * 0.4 + gb_prob * 0.4 + nn_prob * 0.2
    
    # Convert to credit score (higher is better)
    credit_score = max(0, min(100, 100 - (ensemble_prob * 100)))
    
    # Traditional risk metrics
    capacity = monthly_income - monthly_expenses - existing_emi
    dscr = capacity / (desired_emi + 1e-6) if desired_emi > 0 else 0.0
    
    # Advanced risk metrics
    pd_1y = ensemble_prob  # Probability of Default in 1 year
    lgd = 0.45  # Loss Given Default (typical for unsecured micro loans)
    expected_loss = pd_1y * lgd * desired_emi * 12  # Annual expected loss
    
    # Value at Risk (95% confidence)
    mc_results = monte_carlo_simulation(features, 500)
    var_95 = np.percentile(mc_results, 95) * desired_emi * 12
    
    # SHAP approximation
    shap_values = calculate_shap_approximation(features, [rf_model, gb_model, nn_model])
    top_shap = sorted(shap_values, key=lambda x: abs(x[1]), reverse=True)[:3]
    
    # Alternative data contribution
    alt_data_features = features[7:]  # Last 5 features are alternative data
    alt_data_score = np.mean([digital_footprint/10, (social_sentiment+1)/2, 
                             min(location_stability/60, 1), min(transaction_velocity/100, 1), 
                             network_score/10])
    
    # Generate signals based on ML insights
    signals = []
    
    if ensemble_prob < 0.15:
        signals.append("ðŸŸ¢ ML Ensemble: Very low default risk (PD < 15%)")
    elif ensemble_prob < 0.30:
        signals.append("ðŸŸ¡ ML Ensemble: Moderate default risk (PD 15-30%)")
    else:
        signals.append("ðŸ”´ ML Ensemble: High default risk (PD > 30%)")
    
    if alt_data_score > 0.7:
        signals.append("ðŸ“± Strong digital behavior & network signals")
    elif alt_data_score < 0.4:
        signals.append("âš ï¸ Weak alternative data signals detected")
    
    if dscr >= 1.5:
        signals.append("ðŸ’° Strong debt service coverage ratio")
    elif dscr < 1.0:
        signals.append("âš ï¸ Insufficient debt service coverage")
    
    # Risk band determination
    if credit_score >= 75:
        band = "ðŸŸ¢ PRIME Â· ML-Approved"
        summary = f"Strong borrower profile with {ensemble_prob:.1%} default probability. ML models show consistent low-risk signals across traditional and alternative data."
    elif credit_score >= 55:
        band = "ðŸŸ¡ NEAR-PRIME Â· Conditional"
        summary = f"Moderate risk profile with {ensemble_prob:.1%} default probability. Consider risk-based pricing or additional safeguards."
    else:
        band = "ðŸ”´ SUB-PRIME Â· High Risk"
        summary = f"Elevated risk profile with {ensemble_prob:.1%} default probability. Requires enhanced due diligence or decline."
    
    # Generate actionable tips
    tips = []
    if ensemble_prob > 0.3:
        tips.append("Consider requiring co-guarantor or collateral")
    if dscr < 1.2:
        tips.append("Reduce loan amount or extend tenure to improve DSCR")
    if alt_data_score < 0.5:
        tips.append("Gather additional verification through references or utility bills")
    if digital_footprint < 4:
        tips.append("Low digital presence - consider manual verification processes")
    
    return {
        "score": round(credit_score, 1),
        "band": band,
        "summary": summary,
        "signals": signals,
        "tips": tips,
        "dscr": round(dscr, 2),
        "capacity": round(capacity, 1),
        "pd_1y": round(pd_1y * 100, 2),  # Convert to percentage
        "expected_loss": round(expected_loss, 0),
        "var_95": round(var_95, 0),
        "model_contributions": {
            "catboost": round(rf_prob * 100, 1),  # Using RF as proxy for CatBoost
            "xgboost": round(gb_prob * 100, 1),   # Using GB as proxy for XGBoost
            "neural_net": round(nn_prob * 100, 1)
        },
        "shap_summary": f"{top_shap[0][0]}: {top_shap[0][1]:.3f}",
        "altdata_contribution": round(alt_data_score * 100, 1)
    }
`;
      await pyodide.runPythonAsync(advancedPythonCode);
      scoreFn = pyodide.globals.get("score_borrower_advanced");

      updateStatus("ðŸš€ Advanced ML ensemble ready â€“ enhanced with alternative data analytics", "ready");
    }

    function updateStatus(text, state) {
      const pill = document.getElementById("status-pill");
      const dot = document.getElementById("status-dot");
      const label = document.getElementById("status-text");
      label.textContent = text;
      if (state === "loading") {
        dot.className = "h-2 w-2 rounded-full bg-amber-400 animate-pulse";
      } else if (state === "ready") {
        dot.className = "h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.9)]";
      } else if (state === "error") {
        dot.className = "h-2 w-2 rounded-full bg-rose-500";
      }
    }

    function formToPayload(form) {
      const data = new FormData(form);
      const payload = {};
      for (const [key, value] of data.entries()) {
        payload[key] = value;
      }
      return payload;
    }

    function generateDummyData() {
      // Generate realistic dummy borrower profiles with various risk levels
      const profiles = [
        {
          name: "High-Income Trader",
          monthly_income: "35000",
          monthly_expenses: "18000",
          existing_emi: "2000",
          desired_emi: "8000",
          years_in_business: "6",
          household_size: "4",
          past_delay_days: "0",
          sector: "trade",
          repeat_borrower: "yes",
          repayment_freq: "monthly",
          digital_footprint: "8",
          social_sentiment: "0.3",
          location_stability: "48",
          transaction_velocity: "85",
          network_score: "8"
        },
        {
          name: "New Entrepreneur", 
          monthly_income: "18000",
          monthly_expenses: "14000",
          existing_emi: "0",
          desired_emi: "3500",
          years_in_business: "1",
          household_size: "3",
          past_delay_days: "0",
          sector: "services",
          repeat_borrower: "no",
          repayment_freq: "weekly",
          digital_footprint: "6",
          social_sentiment: "0.1",
          location_stability: "12",
          transaction_velocity: "35",
          network_score: "6"
        },
        {
          name: "Established Farmer",
          monthly_income: "22000",
          monthly_expenses: "13000",
          existing_emi: "4000",
          desired_emi: "5000",
          years_in_business: "8",
          household_size: "6",
          past_delay_days: "5",
          sector: "agri",
          repeat_borrower: "other",
          repayment_freq: "monthly",
          digital_footprint: "4",
          social_sentiment: "-0.1",
          location_stability: "96",
          transaction_velocity: "25",
          network_score: "5"
        },
        {
          name: "Salaried Professional",
          monthly_income: "45000",
          monthly_expenses: "25000",
          existing_emi: "8000",
          desired_emi: "10000",
          years_in_business: "5",
          household_size: "4",
          past_delay_days: "0",
          sector: "salaried",
          repeat_borrower: "yes",
          repayment_freq: "monthly",
          digital_footprint: "9",
          social_sentiment: "0.4",
          location_stability: "60",
          transaction_velocity: "120",
          network_score: "9"
        },
        {
          name: "Risky Borrower",
          monthly_income: "15000",
          monthly_expenses: "12000",
          existing_emi: "3500",
          desired_emi: "4000",
          years_in_business: "0.5",
          household_size: "7",
          past_delay_days: "25",
          sector: "other",
          repeat_borrower: "other",
          repayment_freq: "weekly",
          digital_footprint: "3",
          social_sentiment: "-0.3",
          location_stability: "6",
          transaction_velocity: "15",
          network_score: "3"
        }
      ];

      // Randomly select one profile
      const selectedProfile = profiles[Math.floor(Math.random() * profiles.length)];
      
      // Populate form with selected profile data
      populateForm(selectedProfile);
      
      // Show notification
      updateStatus(`ðŸ“Š Generated test data: ${selectedProfile.name} profile`, "ready");
    }

    function populateForm(data) {
      // Populate all form fields with the dummy data
      Object.keys(data).forEach(key => {
        if (key !== 'name') { // Skip the name field as it's not in the form
          const input = document.querySelector(`[name="${key}"]`);
          if (input) {
            input.value = data[key];
            
            // Add visual feedback for populated fields
            input.classList.add('border-emerald-400', 'bg-emerald-950/30');
            setTimeout(() => {
              input.classList.remove('border-emerald-400', 'bg-emerald-950/30');
            }, 1500);
          }
        }
      });
    }

    function renderResult(result, payload) {
      const card = document.getElementById("result-card");
      card.classList.remove("hidden");

      const bandLabel = document.getElementById("band-label");
      const scoreLabel = document.getElementById("score-label");
      const summary = document.getElementById("summary-text");
      const signalsList = document.getElementById("signals-list");

      bandLabel.textContent = result.band;
      scoreLabel.textContent = result.score.toString();
      summary.textContent = result.summary + ` (DSCR: ${result.dscr}, Net capacity: â‚¹${result.capacity?.toFixed(0) || 0}/month)`;      

      // Update advanced risk metrics
      document.getElementById("pd-label").textContent = `${result.pd_1y}%`;
      document.getElementById("el-label").textContent = `â‚¹${result.expected_loss?.toLocaleString() || 0}`;
      document.getElementById("var-label").textContent = `â‚¹${result.var_95?.toLocaleString() || 0}`;

      // Update SHAP and alternative data summaries
      document.getElementById("shap-summary").textContent = result.shap_summary || "â€“";
      document.getElementById("altdata-summary").textContent = `${result.altdata_contribution}% positive`;

      // Update model contributions
      const modelContrib = result.model_contributions || {};
      document.getElementById("catboost-contrib").textContent = `${modelContrib.catboost || 0}%`;
      document.getElementById("xgboost-contrib").textContent = `${modelContrib.xgboost || 0}%`;
      document.getElementById("nn-contrib").textContent = `${modelContrib.neural_net || 0}%`;

      // Colour band label by band
      if (result.score >= 75) {
        bandLabel.className = "text-lg font-semibold text-emerald-300";
      } else if (result.score >= 55) {
        bandLabel.className = "text-lg font-semibold text-amber-300";
      } else {
        bandLabel.className = "text-lg font-semibold text-rose-300";
      }

      signalsList.innerHTML = "";
      (result.signals || []).forEach(sig => {
        const li = document.createElement("li");
        li.textContent = sig;
        signalsList.appendChild(li);
      });
      (result.tips || []).forEach(tip => {
        const li = document.createElement("li");
        li.textContent = "ðŸ’¡ " + tip;
        li.classList.add("text-blue-300");
        signalsList.appendChild(li);
      });

      // Configure WhatsApp share
      const shareBtn = document.getElementById("share-wa-btn");
      shareBtn.onclick = () => {
        const borrowerIncome = payload.monthly_income || "";
        const desiredEmi = payload.desired_emi || "";
        const text =
          `Advanced ML Credit Risk Analysis%0A` +
          `ðŸš€ ML Score: ${result.score}/100 (${result.band})%0A` +
          `ðŸ“Š Default Probability (1Y): ${result.pd_1y}%%0A` +
          `ðŸ’° Expected Loss: â‚¹${result.expected_loss?.toLocaleString() || 0}%0A` +
          `âš¡ Income: â‚¹${borrowerIncome} Â· EMI: â‚¹${desiredEmi}%0A` +
          `ðŸ” DSCR: ${result.dscr}, Net capacity: â‚¹${result.capacity?.toFixed(0) || 0}/month%0A%0A` +
          `ðŸ¤– ML Ensemble Signals:%0A- ${(result.signals || []).join("%0A- ")}%0A%0A` +
          `ðŸ“ˆ Model Performance:%0A` +
          `- CatBoost: ${modelContrib.catboost || 0}%%0A` +
          `- XGBoost: ${modelContrib.xgboost || 0}%%0A` +
          `- Neural Network: ${modelContrib.neural_net || 0}%%0A%0A` +
          `ðŸ’¼ Summary: ${result.summary}`;
        const url = `https://wa.me/?text=${text}`;
        window.open(url, "_blank");
      };
    }

    document.getElementById("score-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!pyodide || !scoreFn) {
        updateStatus("Engine still initialising, please wait a momentâ€¦", "loading");
        return;
      }
      updateStatus("ðŸš€ Running advanced ML ensemble analysisâ€¦", "loading");
      const payload = formToPayload(e.target);
      try {
        const pyData = pyodide.toPy(payload);
        const resPy = scoreFn(pyData);
        const result = resPy.toJs();
        renderResult(result, payload);
        updateStatus("âœ… Advanced ML analysis complete. Adjust inputs and re-run for new scenarios.", "ready");
      } catch (err) {
        console.error("ML Analysis Error:", err);
        updateStatus("âŒ Error in ML analysis â€“ check inputs and try again.", "error");
      }
    });

    // Add event listener for dummy data generation
    document.getElementById("generate-dummy-btn").addEventListener("click", () => {
      generateDummyData();
    });

    // Kick off Pyodide initialisation
    initPyodideAndModel();
  </script>
</body>
</html>
