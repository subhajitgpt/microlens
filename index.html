<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nano Creditworthiness Checker ¬∑ Advanced ML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top, #020617 0, #000 65%);
    }
    .glass {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.97), rgba(15,23,42,0.99));
      backdrop-filter: blur(12px);
    }
    .pill {
      border-radius: 999px;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Top row -->
    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="inline-flex items-center gap-2 pill border border-indigo-500/60 bg-slate-900/70 px-3 py-1 text-[11px] tracking-[0.18em] uppercase">
        <span class="h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.9)]"></span>
        Nano Credit Pre-Screen ¬∑ Demo
      </div>
      <div id="status-pill" class="pill border border-slate-600 bg-slate-900/70 px-3 py-1 text-[11px] text-slate-300 flex items-center gap-2">
        <span id="status-dot" class="h-2 w-2 rounded-full bg-slate-500"></span>
        <span id="status-text">Loading ML engine (Pyodide + scikit-learn)‚Ä¶</span>
      </div>
    </div>

    <!-- Title -->
    <div class="mt-4">
      <h1 class="text-2xl md:text-3xl font-semibold">Advanced ML Credit Risk Analytics Platform</h1>
      <p class="mt-2 text-sm text-slate-300/80 max-w-3xl">
        Next-generation credit scoring using ensemble machine learning, alternative data analytics, and explainable logic. 
        High income, low expenses and clean behaviour are rewarded; weak capacity and poor history increase risk. 
        
      </p>
    </div>

    <!-- Main grid -->
    <div class="mt-6 grid gap-6 lg:grid-cols-[minmax(0,2.1fr)_minmax(320px,1fr)] items-start">
      <!-- LEFT: FORM -->
      <form id="score-form" class="glass border border-slate-700/70 rounded-3xl shadow-2xl p-6 space-y-4">
        <!-- Income / expenses -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Monthly household income (‚Çπ)
              <span class="text-[10px] text-slate-400">eg. 18000</span>
            </label>
            <input type="number" name="monthly_income" value="18000" required
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Monthly essential expenses (‚Çπ)
              <span class="text-[10px] text-slate-400">rent, food, utilities</span>
            </label>
            <input type="number" name="monthly_expenses" value="14000" required
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Existing EMIs (‚Çπ/month)
              <span class="text-[10px] text-slate-400">other loans</span>
            </label>
            <input type="number" name="existing_emi" value="0"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Desired new EMI (‚Çπ/month)
              <span class="text-[10px] text-slate-400">for this loan</span>
            </label>
            <input type="number" name="desired_emi" value="1500" required
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Household size
              <span class="text-[10px] text-slate-400">people</span>
            </label>
            <input type="number" name="household_size" value="3"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>

        <!-- Business / behaviour -->
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="text-xs text-slate-300">Years in main occupation</label>
            <input type="number" name="years_in_business" value="5" min="0.1" step="0.1"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Past delay days (worst)
              <span class="text-[10px] text-slate-400">0 if new</span>
            </label>
            <input type="number" name="past_delay_days" value="0"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300">Repeat borrower?</label>
            <select name="repeat_borrower"
                    class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="no">No ‚Äì first time</option>
              <option value="yes">Yes ‚Äì with us</option>
              <option value="other">Yes ‚Äì with other lender</option>
            </select>
          </div>
        </div>

        <!-- Cash flow -->
        <div class="pt-2">
          <h3 class="text-sm font-semibold text-slate-200 mb-3 flex items-center gap-2">
            <span>üí∞</span> Advanced Cash Flow Analysis
          </h3>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Seasonal income variation (%)
              <span class="text-[10px] text-slate-400">0‚Äì100%</span>
            </label>
            <input type="number" name="seasonal_variation" value="40" min="0" max="100"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Emergency fund (months)
              <span class="text-[10px] text-slate-400">expense coverage</span>
            </label>
            <input type="number" name="emergency_fund" value="0" min="0" max="24" step="0.5"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Business cash cycle (days)
              <span class="text-[10px] text-slate-400">receivables + inventory</span>
            </label>
            <input type="number" name="cash_cycle" value="30" min="0" max="365"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Average monthly savings (‚Çπ)
              <span class="text:[10px] text-slate-400">after all expenses</span>
            </label>
            <input type="number" name="monthly_savings" value="15000" min="0"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Asset collateral ratio (%)
              <span class="text-[10px] text-slate-400">assets vs loan</span>
            </label>
            <input type="number" name="collateral_ratio" value="20" min="0" max="500"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-300">Main livelihood / sector</label>
            <select name="sector"
                    class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="services">Services (beauty, repair, etc.)</option>
              <option value="trade">Small trade / shop</option>
              <option value="agri">Agri / allied</option>
              <option value="salaried">Salaried / fixed income</option>
              <option value="other">Other / irregular</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-300">Repayment frequency</label>
            <select name="repayment_freq"
                    class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-xs focus:outline-none focus:ring-1 focus:ring-indigo-500">
              <option value="weekly">Weekly</option>
              <option value="fortnightly">Fortnightly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </div>

        <!-- Alternative data -->
        <div class="pt-2">
          <h3 class="text-sm font-semibold text-slate-200 mb-3 flex items-center gap-2">
            <span>üî¨</span> Advanced Risk Analytics (Alternative Data)
          </h3>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Digital footprint score
              <span class="text-[10px] text-slate-400">1‚Äì10 scale</span>
            </label>
            <input type="number" name="digital_footprint" value="6" min="1" max="10"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Social media sentiment
              <span class="text-[10px] text-slate-400">-1 to 1</span>
            </label>
            <input type="number" name="social_sentiment" value="0.1" min="-1" max="1" step="0.1"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Location stability (months)
              <span class="text-[10px] text-slate-400">same address</span>
            </label>
            <input type="number" name="location_stability" value="12" min="0"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Transaction velocity (monthly)
              <span class="text-[10px] text-slate-400">digital transactions</span>
            </label>
            <input type="number" name="transaction_velocity" value="30" min="0"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-slate-300 flex justify-between">
              Network analysis score
              <span class="text-[10px] text-slate-400">peer risk 1‚Äì10</span>
            </label>
            <input type="number" name="network_score" value="6" min="1" max="10"
                   class="mt-1 w-full rounded-full bg-slate-900/80 border border-slate-600 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" />
          </div>
        </div>

        <!-- Buttons -->
        <div class="pt-4 flex flex-col sm:flex-row gap-3 items-stretch sm:items-center">
          <button type="submit"
                  class="inline-flex items-center justify-center gap-2 pill bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 px-6 py-3 text-sm font-semibold text-white shadow-xl shadow-indigo-900/50 transition-all duration-200 transform hover:scale-105 hover:shadow-2xl">
            <span class="text-base">üöÄ</span>
            <span>Run Advanced ML Risk Analysis</span>
          </button>
          <button type="button" id="generate-dummy-btn"
                  class="inline-flex items-center justify-center gap-2 pill bg-gradient-to-r from-slate-700 to-slate-600 hover:from-slate-600 hover:to-slate-500 border border-slate-400/50 px-6 py-3 text-sm font-medium text-slate-100 shadow-lg shadow-slate-900/30 transition-all duration-200 transform hover:scale-105 hover:shadow-xl">
            <span class="text-base">üé≤</span>
            <span>Generate Test Profile</span>
          </button>
        </div>

        <p class="mt-1 text-[11px] text-slate-400">
          ML ensemble (Random Forest + Gradient Boosting + Neural Net) trained on synthetic data aligned to simple,
          monotonic credit-risk logic. Score and explanations both come from the same drivers.
        </p>
      </form>

      <!-- RIGHT: RESULT PANEL -->
      <div class="glass border border-slate-700/80 rounded-3xl shadow-2xl p-6 space-y-4 min-h-[360px]" id="result-wrapper">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-400">
              Advanced ML Decision
            </div>
            <div id="band-label" class="mt-2 text-lg font-semibold text-slate-300">
              Waiting for analysis‚Ä¶
            </div>
          </div>
          <div class="text-right">
            <div class="text-[11px] text-slate-400">Credit Score</div>
            <div id="score-label" class="text-2xl font-bold">‚Äì / 100</div>
            <div class="text-[10px] text-slate-500 mt-0.5">(0 = worst, 100 = best)</div>
          </div>
        </div>

        <!-- PD / EL / VaR -->
        <div class="grid grid-cols-3 gap-2 text-xs">
          <div class="bg-slate-900/80 rounded-xl p-3 text-center border border-slate-700/70">
            <div class="text-[10px] text-slate-400 uppercase tracking-wide">PD (1Y)</div>
            <div id="pd-label" class="mt-1 text-base font-semibold text-amber-300">‚Äì</div>
          </div>
          <div class="bg-slate-900/80 rounded-xl p-3 text-center border border-slate-700/70">
            <div class="text-[10px] text-slate-400 uppercase tracking-wide">Expected Loss</div>
            <div id="el-label" class="mt-1 text-base font-semibold text-rose-300">‚Äì</div>
          </div>
          <div class="bg-slate-900/80 rounded-xl p-3 text-center border border-slate-700/70">
            <div class="text-[10px] text-slate-400 uppercase tracking-wide">VaR 95%</div>
            <div id="var-label" class="mt-1 text-base font-semibold text-purple-300">‚Äì</div>
          </div>
        </div>

        <!-- Core metrics -->
        <div class="border border-slate-700/70 rounded-xl p-3 text-xs bg-slate-900/60">
          <div class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-2">Core Metrics</div>
          <div class="flex justify-between">
            <div class="text-slate-300">DSCR (capacity / EMI): <span id="dscr-label" class="font-semibold">‚Äì</span></div>
            <div class="text-slate-300 text-right">Net capacity / month: <span id="capacity-label" class="font-semibold">‚Äì</span></div>
          </div>
        </div>

        <!-- Why this score -->
        <div>
          <div class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1">
            Why this score (simple English)
          </div>
          <p id="summary-text" class="text-xs text-slate-200 leading-relaxed">
            Run an analysis to see a plain-language explanation of the risk score.
          </p>
        </div>

        <!-- What helped / hurt -->
        <div class="grid md:grid-cols-2 gap-3 text-xs">
          <div class="bg-slate-900/70 rounded-xl p-3 border border-emerald-700/60">
            <div class="text-[11px] font-semibold text-emerald-300 mb-1">What helped</div>
            <ul id="helped-list" class="space-y-1 list-disc list-inside text-slate-200"></ul>
          </div>
          <div class="bg-slate-900/70 rounded-xl p-3 border border-rose-700/60">
            <div class="text-[11px] font-semibold text-rose-300 mb-1">What increased risk</div>
            <ul id="risk-list" class="space-y-1 list-disc list-inside text-slate-200"></ul>
          </div>
        </div>

        <!-- Model signals -->
        <div>
          <div class="text-[10px] uppercase tracking-[0.16em] text-slate-400 mb-1">ML Model Signals</div>
          <ul id="signals-list" class="text-xs text-slate-200 space-y-1 list-disc list-inside"></ul>
        </div>

        <!-- Advanced analytics -->
        <div class="grid md:grid-cols-2 gap-3 text-xs">
          <div class="bg-slate-900/70 rounded-xl p-3 border border-slate-700/70">
            <div class="text-[10px] uppercase tracking-[0.14em] text-slate-400 mb-1">Top driver (SHAP-style)</div>
            <div id="shap-summary" class="text-slate-200">‚Äì</div>
          </div>
          <div class="bg-slate-900/70 rounded-xl p-3 border border-slate-700/70">
            <div class="text-[10px] uppercase tracking-[0.14em] text-slate-400 mb-1">Alt data contribution</div>
            <div id="altdata-summary" class="text-slate-200">‚Äì</div>
          </div>
        </div>

        <!-- Ensemble contributions -->
        <div class="bg-slate-900/70 rounded-xl p-3 border border-slate-700/70 text-xs">
          <div class="text-[10px] uppercase tracking-[0.14em] text-slate-400 mb-1">Ensemble model confidence</div>
          <div class="grid grid-cols-3 gap-2">
            <div>Random Forest: <span id="rf-contrib" class="font-semibold text-emerald-300">‚Äì</span></div>
            <div>GradBoost: <span id="gb-contrib" class="font-semibold text-sky-300">‚Äì</span></div>
            <div>Neural Net: <span id="nn-contrib" class="font-semibold text-purple-300">‚Äì</span></div>
          </div>
        </div>

        <!-- Smart recommendations -->
        <div class="bg-slate-900/70 rounded-xl p-3 border border-amber-600/70 text-xs">
          <div class="text-[10px] uppercase tracking-[0.14em] text-amber-300 mb-1">
            Smart recommendations to improve score
          </div>
          <ul id="reco-list" class="space-y-1 list-disc list-inside text-slate-200"></ul>
        </div>

        <!-- Share button -->
        <button id="share-wa-btn"
                class="w-full pill border border-emerald-500/70 text-emerald-200 text-xs px-3 py-2 mt-1 hover:bg-emerald-500/10 flex items-center justify-center gap-2">
          <span>üì≤</span>
          <span>Share Advanced Risk Analysis</span>
        </button>

        <p class="text-[10px] text-slate-500">
          All scoring runs fully in-browser. This is a demonstration of next-gen nano-credit pre-screening.
        </p>
      </div>
    </div>
  </div>

  <script>
    let pyodide = null;
    let scoreFn = null;

    function updateStatus(text, state) {
      const dot = document.getElementById("status-dot");
      const label = document.getElementById("status-text");
      label.textContent = text;
      if (state === "loading") {
        dot.className = "h-2 w-2 rounded-full bg-amber-400 animate-pulse";
      } else if (state === "ready") {
        dot.className = "h-2 w-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.9)]";
      } else if (state === "error") {
        dot.className = "h-2 w-2 rounded-full bg-rose-500";
      } else {
        dot.className = "h-2 w-2 rounded-full bg-slate-500";
      }
    }

    function formToPayload(form) {
      const data = new FormData(form);
      const payload = {};
      for (const [k, v] of data.entries()) {
        payload[k] = v;
      }
      return payload;
    }

    async function initPyodideAndModel() {
      try {
        updateStatus("Loading Pyodide runtime‚Ä¶", "loading");
        pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
        });
        updateStatus("Installing ML packages (numpy, scikit-learn)‚Ä¶", "loading");
        await pyodide.loadPackage(["numpy", "scikit-learn"]);

        const pyCode = `
import numpy as np
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.neural_network import MLPClassifier
from sklearn.preprocessing import StandardScaler

rng = np.random.default_rng(42)

def _synthetic_risk_logic(
    monthly_income,
    monthly_expenses,
    existing_emi,
    desired_emi,
    years_in_business,
    household_size,
    past_delay_days,
    digital_footprint,
    social_sentiment,
    location_stability,
    transaction_velocity,
    network_score,
    emergency_fund,
    seasonal_variation,
):
    # capacity & DSCR
    capacity = monthly_income - monthly_expenses - existing_emi
    emi = np.maximum(desired_emi, 100.0)
    dscr = capacity / emi

    # base z for logistic PD
    z = 0.0

    # DSCR: strong negative contribution (higher DSCR => lower risk)
    z += -2.0 * np.tanh(dscr - 1.3)

    # payment history
    z += 1.6 * np.clip(past_delay_days / 30.0, 0, 2)

    # experience (less experience => more risk)
    z += 0.9 * np.clip((2.0 - years_in_business) / 2.0, 0, 1)

    # large households slightly increase risk
    z += 0.6 * np.clip((household_size - 5.0) / 5.0, 0, 1)

    # alternative data: build score 0‚Äì1 (higher = better)
    alt_score = np.clip(np.stack([
        digital_footprint / 10.0,
        (social_sentiment + 1.0) / 2.0,
        np.clip(location_stability / 36.0, 0, 1),
        np.clip(transaction_velocity / 80.0, 0, 1),
        network_score / 10.0
    ], axis=-1).mean(axis=-1), 0, 1)

    # penalty when alt_score is low
    z += 1.4 * np.clip(0.6 - alt_score, 0, 0.6) / 0.6

    # emergency buffer reduces risk
    z += -1.2 * np.clip(emergency_fund / 6.0, 0, 1)

    # high seasonal variation slightly increases risk
    z += 0.5 * np.clip(seasonal_variation / 80.0, 0, 1)

    # small noise
    z += rng.normal(0, 0.35, size=np.shape(z))

    # convert to PD via logistic
    pd = 1.0 / (1.0 + np.exp(-z))
    return pd, dscr, capacity, alt_score

def generate_synthetic_training_data(n_samples=2000):
    # draw features
    monthly_income = rng.normal(25000, 10000, n_samples).clip(5000, 120000)
    monthly_expenses = rng.normal(15000, 7000, n_samples).clip(2000, 80000)
    existing_emi = rng.normal(4000, 3000, n_samples).clip(0, 25000)
    desired_emi = rng.normal(6000, 3000, n_samples).clip(1000, 25000)
    years_in_business = rng.exponential(4, n_samples).clip(0.2, 30)
    household_size = rng.poisson(4, n_samples).clip(1, 10)
    past_delay_days = rng.exponential(5, n_samples).clip(0, 90)
    digital_footprint = rng.normal(6, 2, n_samples).clip(1, 10)
    social_sentiment = rng.normal(0.1, 0.4, n_samples).clip(-1, 1)
    location_stability = rng.exponential(24, n_samples).clip(1, 120)
    transaction_velocity = rng.poisson(50, n_samples).clip(0, 200)
    network_score = rng.normal(6.5, 2, n_samples).clip(1, 10)
    emergency_fund = rng.exponential(2, n_samples).clip(0, 12)
    seasonal_variation = rng.normal(30, 20, n_samples).clip(0, 100)

    pd_true, dscr, capacity, alt_score = _synthetic_risk_logic(
        monthly_income,
        monthly_expenses,
        existing_emi,
        desired_emi,
        years_in_business,
        household_size,
        past_delay_days,
        digital_footprint,
        social_sentiment,
        location_stability,
        transaction_velocity,
        network_score,
        emergency_fund,
        seasonal_variation,
    )

    y = (pd_true > 0.5).astype(int)

    X = np.column_stack([
        monthly_income,
        monthly_expenses,
        existing_emi,
        desired_emi,
        years_in_business,
        household_size,
        past_delay_days,
        digital_footprint,
        social_sentiment,
        location_stability,
        transaction_velocity,
        network_score,
        emergency_fund,
        seasonal_variation,
        dscr,
        capacity,
        alt_score
    ])

    return X, y

def train_ensemble_models():
    X, y = generate_synthetic_training_data(2500)

    rf = RandomForestClassifier(
        n_estimators=80, max_depth=10, random_state=42, min_samples_leaf=5
    )
    gb = GradientBoostingClassifier(
        n_estimators=80, max_depth=3, learning_rate=0.08, random_state=42
    )
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(X)
    nn = MLPClassifier(
        hidden_layer_sizes=(32, 16), max_iter=350, random_state=42
    )

    rf.fit(X, y)
    gb.fit(X, y)
    nn.fit(X_scaled, y)

    return rf, gb, nn, scaler

rf_model, gb_model, nn_model, scaler = train_ensemble_models()

def score_borrower_advanced(d: dict):
    # parse numeric values safely
    def _f(name, default):
        v = d.get(name, default)
        try:
            return float(v)
        except Exception:
            return float(default)

    monthly_income = max(_f("monthly_income", 20000), 0)
    monthly_expenses = max(_f("monthly_expenses", 12000), 0)
    existing_emi = max(_f("existing_emi", 0), 0)
    desired_emi = max(_f("desired_emi", 5000), 1)
    years_in_business = max(_f("years_in_business", 3), 0.1)
    household_size = max(_f("household_size", 4), 1)
    past_delay_days = max(_f("past_delay_days", 0), 0)
    digital_footprint = _f("digital_footprint", 5)
    social_sentiment = _f("social_sentiment", 0)
    location_stability = _f("location_stability", 24)
    transaction_velocity = _f("transaction_velocity", 40)
    network_score = _f("network_score", 7)
    emergency_fund = _f("emergency_fund", 1)
    seasonal_variation = _f("seasonal_variation", 30)

    # engineered metrics from same logic function (for consistency)
    pd_true, dscr_true, capacity_true, alt_score_true = _synthetic_risk_logic(
        monthly_income,
        monthly_expenses,
        existing_emi,
        desired_emi,
        years_in_business,
        household_size,
        past_delay_days,
        digital_footprint,
        social_sentiment,
        location_stability,
        transaction_velocity,
        network_score,
        emergency_fund,
        seasonal_variation,
    )

    dscr = float(dscr_true)
    capacity = float(capacity_true)
    alt_score = float(alt_score_true)

    X = np.array([[
        monthly_income,
        monthly_expenses,
        existing_emi,
        desired_emi,
        years_in_business,
        household_size,
        past_delay_days,
        digital_footprint,
        social_sentiment,
        location_stability,
        transaction_velocity,
        network_score,
        emergency_fund,
        seasonal_variation,
        dscr,
        capacity,
        alt_score
    ]])

    rf_pd = rf_model.predict_proba(X)[0, 1]
    gb_pd = gb_model.predict_proba(X)[0, 1]
    nn_pd = nn_model.predict_proba(scaler.transform(X))[0, 1]

    # weighted ensemble PD
    pd_ml = 0.4 * rf_pd + 0.4 * gb_pd + 0.2 * nn_pd
    pd_ml = float(np.clip(pd_ml, 0.01, 0.99))

    # score (higher is better)
    score = 100.0 * (1.0 - pd_ml)

    # simple risk band
    if pd_ml < 0.15:
        band = "üü¢ PRIME ¬∑ Low Risk"
    elif pd_ml < 0.35:
        band = "üü° NEAR-PRIME ¬∑ Medium Risk"
    else:
        band = "üî¥ SUB-PRIME ¬∑ High Risk"

    # expected loss & VaR (demo-level)
    lgd = 0.45
    annual_emi = desired_emi * 12.0
    expected_loss = pd_ml * lgd * annual_emi
    var_95 = np.percentile(
        [pd_ml + rng.normal(0, 0.05) for _ in range(500)], 95
    ) * annual_emi

    # "SHAP-style" explanation with RF importance * normalized features
    importances = rf_model.feature_importances_
    feature_names = [
        "income", "expenses", "existing_emi", "desired_emi",
        "years_in_business", "household_size", "past_delay_days",
        "digital_footprint", "social_sentiment", "location_stability",
        "transaction_velocity", "network_score",
        "emergency_fund", "seasonal_variation",
        "dscr", "capacity", "alt_score"
    ]
    feats = X[0]
    norm = (feats - feats.mean()) / (feats.std() + 1e-6)
    shap_like = norm * importances
    top_idx = int(np.argsort(np.abs(shap_like))[-1])
    shap_summary = f"{feature_names[top_idx]}: {shap_like[top_idx]:+.3f}"

    return {
        "score": round(float(score), 1),
        "pd": round(float(pd_ml) * 100.0, 2),
        "band": band,
        "dscr": round(float(dscr), 2),
        "capacity": round(float(capacity), 0),
        "expected_loss": round(float(expected_loss), 0),
        "var_95": round(float(var_95), 0),
        "rf_pd": round(float(rf_pd) * 100.0, 2),
        "gb_pd": round(float(gb_pd) * 100.0, 2),
        "nn_pd": round(float(nn_pd) * 100.0, 2),
        "alt_score": round(float(alt_score) * 100.0, 1),
        "shap_summary": shap_summary,
    }
`;
        await pyodide.runPythonAsync(pyCode);
        scoreFn = pyodide.globals.get("score_borrower_advanced");
        updateStatus("‚úÖ Advanced ML ensemble ready. Enter data and run analysis.", "ready");
      } catch (err) {
        console.error(err);
        updateStatus("‚ùå Error initialising ML engine. See console.", "error");
      }
    }

    function buildNarrativeAndBullets(payload, result) {
      const income = parseFloat(payload.monthly_income || 0);
      const expenses = parseFloat(payload.monthly_expenses || 0);
      const existing = parseFloat(payload.existing_emi || 0);
      const desired = parseFloat(payload.desired_emi || 1);
      const years = parseFloat(payload.years_in_business || 0);
      const hh = parseFloat(payload.household_size || 1);
      const delays = parseFloat(payload.past_delay_days || 0);
      const emergency = parseFloat(payload.emergency_fund || 0);
      const seasonal = parseFloat(payload.seasonal_variation || 0);
      const dig = parseFloat(payload.digital_footprint || 5);
      const sent = parseFloat(payload.social_sentiment || 0);
      const loc = parseFloat(payload.location_stability || 0);
      const txn = parseFloat(payload.transaction_velocity || 0);
      const netScore = parseFloat(payload.network_score || 5);

      const dscr = result.dscr;
      const pd = result.pd / 100.0;

      const helped = [];
      const hurt = [];
      const recos = [];
      const signals = [];

      // Capacity
      if (dscr >= 1.5) {
        helped.push("Repayment capacity is strong ‚Äì DSCR is comfortably above 1.5.");
      } else if (dscr >= 1.2) {
        helped.push("Repayment capacity is acceptable ‚Äì DSCR is above 1.2.");
        recos.push("Slightly reduce EMI or extend tenure to push DSCR towards 1.5+.");
      } else if (dscr >= 1.0) {
        hurt.push("Debt service coverage is tight ‚Äì DSCR is close to 1.0.");
        recos.push("Reduce loan size or lengthen tenure so that DSCR improves above 1.3.");
      } else {
        hurt.push("Current income cannot comfortably cover the requested EMI (DSCR below 1.0).");
        recos.push("Rework ticket size or improve income before approving this loan.");
      }

      // History
      if (delays === 0) {
        helped.push("No recorded past delays, which strongly supports the profile.");
      } else if (delays <= 10) {
        hurt.push("Some minor delays in the past; needs closer monitoring.");
        recos.push("Explain previous delays and set up reminders / auto-debit to avoid repeats.");
      } else {
        hurt.push("Significant historical delays (10+ days) increase default risk.");
        recos.push("Consider co-guarantor or additional checks due to past delay behaviour.");
      }

      // Experience & stability
      if (years >= 5) {
        helped.push("Long and stable occupation history adds comfort around income continuity.");
      } else if (years < 2) {
        hurt.push("Limited experience in current occupation (<2 years) adds uncertainty.");
        recos.push("Ask for additional documents or references to validate new income stream.");
      }

      if (loc >= 36) {
        helped.push("Staying at the same address for 3+ years indicates strong location stability.");
      } else if (loc < 12) {
        hurt.push("Recent address changes (<1 year) can signal some instability.");
        recos.push("Verify current address carefully and capture alternative contact details.");
      }

      // Emergency buffer & savings
      if (emergency >= 3) {
        helped.push(`Emergency savings can cover about ${emergency.toFixed(1)} months of expenses, which is a solid safety cushion.`);
      } else if (emergency === 0) {
        hurt.push("No visible emergency reserve; borrower is vulnerable to income shocks.");
        recos.push("Encourage building a small emergency buffer before taking full exposure.");
      } else {
        hurt.push(`Emergency fund covers only around ${emergency.toFixed(1)} months; buffer is limited.`);
        recos.push("Keep EMI modest so that the client can continue growing their buffer.");
      }

      // Digital / network
      if (dig >= 7) {
        helped.push("Strong digital footprint suggests predictable, trackable behaviour.");
      } else if (dig <= 3) {
        hurt.push("Very low digital footprint ‚Äì data is thin, so manual verification is important.");
        recos.push("Collect additional KYC documents or references to compensate for low digital trail.");
      }

      if (sent > 0.2) {
        helped.push("Positive social sentiment hints at good reputation in the network.");
      } else if (sent < -0.2) {
        hurt.push("Negative sentiment signals some reputation concerns.");
        recos.push("Capture more qualitative feedback from field officers or neighbours.");
      }

      if (netScore >= 8) {
        helped.push("Strong peer network score; customer is well anchored in the community.");
      }

      if (seasonal > 50) {
        hurt.push("Income is highly seasonal; cash flows can fluctuate across months.");
        recos.push("Prefer flexible repayment schedules that align with peak income months.");
      }

      // High-level narrative
      let summary = "";
      if (pd < 0.15) {
        summary = `Risk is in the low zone with an estimated 1-year default probability of about ${(pd * 100).toFixed(1)}%. `
                + `Capacity and behaviour look strong; this is a fundamentally sound profile.`;
      } else if (pd < 0.35) {
        summary = `Risk is in a moderate band with an estimated 1-year default probability of roughly ${(pd * 100).toFixed(1)}%. `
                + `Capacity is mostly comfortable but some weaker factors mean pricing/conditions should compensate.`;
      } else {
        summary = `Risk is elevated with an estimated 1-year default probability near ${(pd * 100).toFixed(1)}%. `
                + `Multiple drivers push this case into a higher-risk band, so enhanced safeguards or restructuring are advisable.`;
      }

      // ML signals
      if (pd < 0.15) {
        signals.push("üü¢ ML ensemble flags low default risk (PD < 15%).");
      } else if (pd < 0.35) {
        signals.push("üü° ML ensemble indicates moderate default risk (15‚Äì35% PD).");
      } else {
        signals.push("üî¥ ML ensemble flags high default risk (PD > 35%).");
      }

      if (result.alt_score >= 70) {
        signals.push("üì± Alternative data signals (digital, location, network) are overall supportive.");
      } else if (result.alt_score < 40) {
        signals.push("‚ö†Ô∏è Alternative data is weak or mixed; do not rely solely on digital signals.");
      }

      if (recos.length === 0) {
        recos.push("Profile already looks strong. The best way to keep the score high is to maintain timely repayments and continue building savings and digital transaction history.");
      }

      return { summary, helped, hurt, recos, signals };
    }

    function renderResult(result, payload) {
      const bandLabel = document.getElementById("band-label");
      const scoreLabel = document.getElementById("score-label");
      const pdLabel = document.getElementById("pd-label");
      const elLabel = document.getElementById("el-label");
      const varLabel = document.getElementById("var-label");
      const dscrLabel = document.getElementById("dscr-label");
      const capLabel = document.getElementById("capacity-label");
      const summaryEl = document.getElementById("summary-text");
      const helpedList = document.getElementById("helped-list");
      const riskList = document.getElementById("risk-list");
      const signalsList = document.getElementById("signals-list");
      const shapEl = document.getElementById("shap-summary");
      const altEl = document.getElementById("altdata-summary");
      const rfEl = document.getElementById("rf-contrib");
      const gbEl = document.getElementById("gb-contrib");
      const nnEl = document.getElementById("nn-contrib");
      const recoList = document.getElementById("reco-list");

      bandLabel.textContent = result.band;
      scoreLabel.textContent = `${result.score.toFixed(1)}/100`;
      if (result.band.includes("Low")) {
        bandLabel.className = "mt-2 text-lg font-semibold text-emerald-300";
      } else if (result.band.includes("Medium")) {
        bandLabel.className = "mt-2 text-lg font-semibold text-amber-300";
      } else {
        bandLabel.className = "mt-2 text-lg font-semibold text-rose-300";
      }

      pdLabel.textContent = `${result.pd.toFixed(2)}%`;
      elLabel.textContent = `‚Çπ${result.expected_loss.toLocaleString()}`;
      varLabel.textContent = `‚Çπ${result.var_95.toLocaleString()}`;
      dscrLabel.textContent = result.dscr.toFixed(2);
      capLabel.textContent = `‚Çπ${result.capacity.toLocaleString()}/month`;

      shapEl.textContent = result.shap_summary;
      altEl.textContent = `${result.alt_score.toFixed(1)}% positive alternative-data signal`;
      rfEl.textContent = `${result.rf_pd.toFixed(2)}% PD`;
      gbEl.textContent = `${result.gb_pd.toFixed(2)}% PD`;
      nnEl.textContent = `${result.nn_pd.toFixed(2)}% PD`;

      const narr = buildNarrativeAndBullets(payload, result);
      summaryEl.textContent = narr.summary;

      helpedList.innerHTML = "";
      narr.helped.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        helpedList.appendChild(li);
      });

      riskList.innerHTML = "";
      narr.hurt.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        riskList.appendChild(li);
      });

      signalsList.innerHTML = "";
      narr.signals.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        signalsList.appendChild(li);
      });

      recoList.innerHTML = "";
      narr.recos.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        recoList.appendChild(li);
      });

      // WhatsApp share
      const shareBtn = document.getElementById("share-wa-btn");
      shareBtn.onclick = () => {
        const txt =
          `Advanced ML Credit Risk Analysis%0A` +
          `Decision: ${encodeURIComponent(result.band)}%0A` +
          `Score: ${result.score.toFixed(1)}/100%0A` +
          `PD (1Y): ${result.pd.toFixed(2)}%%%0A` +
          `DSCR: ${result.dscr.toFixed(2)}%0A` +
          `Net capacity: ‚Çπ${result.capacity.toLocaleString()}/month%0A%0A` +
          `Why: ${encodeURIComponent(narr.summary)}%0A%0A` +
          `What helped:%0A- ${encodeURIComponent(narr.helped.join("%0A- "))}%0A%0A` +
          `What increased risk:%0A- ${encodeURIComponent(narr.hurt.join("%0A- "))}`;
        window.open(`https://wa.me/?text=${txt}`, "_blank");
      };
    }

    // Dummy profiles for quick testing
    function generateDummyProfile() {
      const profiles = [
        {
          name: "Strong Salaried",
          monthly_income: "45000",
          monthly_expenses: "22000",
          existing_emi: "3000",
          desired_emi: "6000",
          household_size: "4",
          years_in_business: "8",
          past_delay_days: "0",
          seasonal_variation: "10",
          emergency_fund: "6",
          cash_cycle: "20",
          monthly_savings: "8000",
          collateral_ratio: "150",
          sector: "salaried",
          repayment_freq: "monthly",
          digital_footprint: "8",
          social_sentiment: "0.4",
          location_stability: "48",
          transaction_velocity: "110",
          network_score: "8"
        },
        {
          name: "Borderline Trader",
          monthly_income: "22000",
          monthly_expenses: "15000",
          existing_emi: "4000",
          desired_emi: "5000",
          household_size: "5",
          years_in_business: "2",
          past_delay_days: "12",
          seasonal_variation: "40",
          emergency_fund: "1",
          cash_cycle: "60",
          monthly_savings: "1500",
          collateral_ratio: "90",
          sector: "trade",
          repayment_freq: "weekly",
          digital_footprint: "5",
          social_sentiment: "0",
          location_stability: "18",
          transaction_velocity: "45",
          network_score: "6"
        },
        {
          name: "High-Risk Irregular",
          monthly_income: "15000",
          monthly_expenses: "13000",
          existing_emi: "3000",
          desired_emi: "4000",
          household_size: "6",
          years_in_business: "1",
          past_delay_days: "35",
          seasonal_variation: "70",
          emergency_fund: "0",
          cash_cycle: "90",
          monthly_savings: "0",
          collateral_ratio: "40",
          sector: "other",
          repayment_freq: "weekly",
          digital_footprint: "3",
          social_sentiment: "-0.3",
          location_stability: "6",
          transaction_velocity: "20",
          network_score: "3"
        }
      ];
      return profiles[Math.floor(Math.random() * profiles.length)];
    }

    function applyDummyToForm(p) {
      const form = document.getElementById("score-form");
      Object.keys(p).forEach(k => {
        const el = form.elements[k];
        if (el) el.value = p[k];
      });
      updateStatus(`üìä Loaded test profile: ${p.name}`, "ready");
    }

    document.getElementById("generate-dummy-btn").addEventListener("click", () => {
      applyDummyToForm(generateDummyProfile());
    });

    document.getElementById("score-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!pyodide || !scoreFn) {
        updateStatus("Engine still initialising, please wait‚Ä¶", "loading");
        return;
      }
      updateStatus("üöÄ Running advanced ML ensemble analysis‚Ä¶", "loading");
      const payload = formToPayload(e.target);
      try {
        const pyData = pyodide.toPy(payload);
        const resPy = scoreFn(pyData);
        const result = resPy.toJs();
        renderResult(result, payload);
        updateStatus("‚úÖ ML analysis complete. Adjust inputs and re-run to see different scenarios.", "ready");
      } catch (err) {
        console.error("ML analysis error:", err);
        updateStatus("‚ùå Error in ML analysis. Check console.", "error");
      }
    });

    // Kickoff
    initPyodideAndModel();
  </script>
</body>
</html>
